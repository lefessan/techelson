<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Creating and Calling Contracts - Techelson User Documentation</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="navy">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="../index.html"><strong aria-hidden="true">1.</strong> Techelson</a></li><li><a href="../michelson/index.html"><strong aria-hidden="true">2.</strong> Michelson</a></li><li><ol class="section"><li><a href="../michelson/simple_example.html"><strong aria-hidden="true">2.1.</strong> A Simple Example</a></li></ol></li><li><a href="../testing/index.html"><strong aria-hidden="true">3.</strong> Running Tests</a></li><li><ol class="section"><li><a href="../testing/basic.html"><strong aria-hidden="true">3.1.</strong> First Steps</a></li><li><a href="../testing/contracts.html" class="active"><strong aria-hidden="true">3.2.</strong> Creating and Calling Contracts</a></li><li><a href="../testing/inspection.html"><strong aria-hidden="true">3.3.</strong> Live Contract Inspection</a></li><li><a href="../testing/anonymous.html"><strong aria-hidden="true">3.4.</strong> Anonymous Contracts</a></li><li><a href="../testing/transfers.html"><strong aria-hidden="true">3.5.</strong> Transfers</a></li><li><a href="../testing/failures.html"><strong aria-hidden="true">3.6.</strong> Testing for Failures</a></li><li><a href="../testing/set_source.html"><strong aria-hidden="true">3.7.</strong> Usurpation of Identity</a></li></ol></li><li><a href="../testgen/index.html"><strong aria-hidden="true">4.</strong> Test Generation</a></li><li><ol class="section"><li><a href="../testgen/example.html"><strong aria-hidden="true">4.1.</strong> Example</a></li></ol></li><li><a href="../quick_ref/index.html"><strong aria-hidden="true">5.</strong> Quick Reference</a></li><li><ol class="section"><li><a href="../quick_ref/extensions.html"><strong aria-hidden="true">5.1.</strong> Extensions</a></li><li><a href="../quick_ref/usage.html"><strong aria-hidden="true">5.2.</strong> Command-Line Usage</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Techelson User Documentation</h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#creating-and-calling-contracts" id="creating-and-calling-contracts"><h1>Creating and Calling Contracts</h1></a>
<p>When you pass a contract to techelson using <code>techelson --contract &lt;file&gt; ...</code>, the contract becomes
a <strong>named</strong> contract in the techelson environment. The name of the contract is the name of the file</p>
<ul>
<li>up to its first <code>.</code> character,</li>
<li>with the first letter capitalized.</li>
</ul>
<p>So</p>
<pre><code>techelson \
    --contract my_contract.tz \
    --contract myContract.tz  \
    --contract my.contract.tz \
    ...
</code></pre>
<p>defines three named contracts: <code>My_contract</code>, <code>MyContract</code> and <code>My</code>.</p>
<blockquote>
<p>Note that the naming convention is the same for testcases, based on the testcase file. The name
of a testcase might be used in techelson's output to provide information, but it has no practical
use currently.</p>
</blockquote>
<a class="header" href="#named-contract-creation" id="named-contract-creation"><h2>Named Contract Creation</h2></a>
<p>Techelson extends the <code>CREATE_CONTRACT</code> michelson instruction with the following rule</p>
<table><thead><tr><th align="left"> instruction </th><th align="center"> parameter </th><th align="center"> stack </th></tr></thead><tbody>
<tr><td align="left"> <code>CREATE_CONTRACT</code> </td><td align="center"> <code>&lt;string&gt;</code> </td><td align="center"> <code>:: key_hash : option key_hash : bool : bool : mutez : 'g : 'S</code> </td></tr>
<tr><td align="left">              </td><td align="center">            </td><td align="center"> <code>-&gt; operation : address : 'S</code> </td></tr>
</tbody></table>
<p>where <code>&lt;string&gt;</code> is the name of a contract with storage type <code>'g</code> in the environment. The semantics
of the stack parameters is the same as in michelson: manager, optional delegate, the two spendable
and delegatable flags, and the balance and storage of the contract created.</p>
<blockquote>
<p><strong>NB</strong>: techelson also provides the <code>SPAWN_CONTRACT</code> extension which takes the name of the
contract on the stack. See techelson's <a href="../quick_ref/extensions.html" title="Extension section">Extensions</a> for more details.</p>
</blockquote>
<p>Say we have the following contract in file <a href="../../rsc/simpleExample/contracts/simpleExample.tz" title="The SimpleExample contract">simpleExample.tz</a>.</p>
<pre><code class="language-mic ignore">storage nat;
parameter bool;
code {
    UNPAIR;        # Unpair parameter and storage.
    IF {           # Asked not to count: storage is unchanged, nothing to do.
    } {
        PUSH nat 1;
        ADD
    };
    NIL operation; # We don't want to perform any operations.
    PAIR           # Aggregate the operation list and the new storage.
};
</code></pre>
<p>We can craft a creation operation in file <a href="../../rsc/simpleExample/okay/create1.techel" title="The Create1 testcase">create1.techel</a> as follows</p>
<pre><code class="language-mic ignore">{
    PUSH @storage nat 0 ;
    PUSH @amount mutez 3 ;
    PUSH @delegatable bool True ;
    PUSH @spendable bool True ;
    NONE @delegate key_hash ;
    PUSH key &quot;manager address&quot; ;
    SHA512 @manager ;
    PRINT_STACK ;
    STEP &quot;before creation&quot; ;

    CREATE_CONTRACT &quot;SimpleExample&quot; ;
    PRINT_STACK ;
    STEP &quot;after creation&quot; ;
}
</code></pre>
<p>This produces the following output</p>
<pre><code>$ techelson --contract rsc/simpleExample/contracts/simpleExample.tz -- rsc/simpleExample/okay/create1.techel
Running test `Create1`
Running test script...
stack:
|==================================================================================================|
|                                                                                         @storage |
| 0                                                                                                |
| nat                                                                                              |
|--------------------------------------------------------------------------------------------------|
|                                                                                          @amount |
| 3utz                                                                                             |
| mutez                                                                                            |
|--------------------------------------------------------------------------------------------------|
|                                                                                     @delegatable |
| True                                                                                             |
| bool                                                                                             |
|--------------------------------------------------------------------------------------------------|
|                                                                                       @spendable |
| True                                                                                             |
| bool                                                                                             |
|--------------------------------------------------------------------------------------------------|
|                                                                                        @delegate |
| None                                                                                             |
| (option key_hash)                                                                                |
|--------------------------------------------------------------------------------------------------|
|                                                                                         @manager |
| &quot;sha512:manager address&quot;                                                                         |
| key_hash                                                                                         |
|==================================================================================================|
Running test script...
stopping [before creation] press `return` to continue

Running test script...
stack:
|==================================================================================================|
| address[1]                                                                                       |
| address                                                                                          |
|--------------------------------------------------------------------------------------------------|
| CREATE[uid:0] (@address[1], &quot;sha512:manager address&quot;, None, true, true, 3utz) &quot;SimpleExample&quot;    |
| operation                                                                                        |
|==================================================================================================|
Running test script...
stopping [after creation] press `return` to continue

Running test script...
Done running test `Create1`

</code></pre>
<a class="header" href="#applying-operations" id="applying-operations"><h2>Applying Operations</h2></a>
<p>Michelson operations (contract/account creation, transfers) cannot be applied directly in a
michelson contract. Instead, a contract produces a list of operation which the tezos runtime
applies after the contract is done running.</p>
<p>A techelson test case needs to be able to apply operations however, which is why the
<code>APPLY_OPERATIONS</code> extension exists. This instruction suspends the execution of the testcase to
apply the list of operations on the top of the stack. When all these operations are done running,
techelson resumes the execution of the testcase.</p>
<blockquote>
<p><strong>Warning</strong>: this instruction is only legal in testcases, not in contracts.</p>
</blockquote>
<p>Consider testcase <a href="../../rsc/simpleExample/okay/create2.techel" title="The Create2 testcase">create2.techel</a>:</p>
<pre><code class="language-mic ignore">{
    PUSH @storage nat 0 ;
    PUSH @amount mutez 3 ;
    PUSH @delegatable bool True ;
    PUSH @spendable bool True ;
    NONE @delegate key_hash ;
    PUSH key &quot;manager address&quot; ;
    SHA512 @manager ;

    CREATE_CONTRACT @main @main_op &quot;SimpleExample&quot; ;

    DIP { NIL operation } ;
    CONS ;
    PRINT_STACK ;
    STEP &quot;operation is now in a list&quot; ;

    APPLY_OPERATIONS ;

    PRINT_STACK ;
    STEP &quot;testing that contract exists&quot; ;
    # Takes the address on the top of the stack, retrieves a contract of parameter `bool`.
    CONTRACT bool ;
    IF_NONE { # There is no hope, failing.
        PUSH @err_msg string &quot;failed to retrieve contract&quot; ;
        FAILWITH
    } {
        PUSH string &quot;success&quot; ;
        PRINT_STACK
    }
}
</code></pre>
<p>Running it yields</p>
<pre><code>$ techelson --contract rsc/simpleExample/contracts/simpleExample.tz -- rsc/simpleExample/okay/create2.techel
Running test `Create2`
Running test script...
stack:
|==================================================================================================|
|                                                                                            @main |
| address[1]@main                                                                                  |
| address                                                                                          |
|--------------------------------------------------------------------------------------------------|
| [ CREATE[uid:0] (@address[1]@main, &quot;sha512:manager address&quot;, None, true, true, 3utz) &quot;SimpleExample&quot; ] |
| (list operation)                                                                                 |
|==================================================================================================|
Running test script...
stopping [operation is now in a list] press `return` to continue

Running test script...

Applying Operations...
Running test script...
stack:
|==================================================================================================|
|                                                                                            @main |
| address[1]@main                                                                                  |
| address                                                                                          |
|==================================================================================================|
Running test script...
stopping [testing that contract exists] press `return` to continue

Running test script...
stack:
|==================================================================================================|
| address[1]@main                                                                                  |
| (contract bool)                                                                                  |
|--------------------------------------------------------------------------------------------------|
| &quot;success&quot;                                                                                        |
| string                                                                                           |
|==================================================================================================|
Running test script...
Done running test `Create2`

</code></pre>
<p>Notice the line <code>Applying operations...</code>. We could increase techelson's verbosity to obtain more
information as to which contracts are deployed, but let's see how to inspect the state of a <em>live</em>
(deployed) contract instead.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../testing/basic.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../testing/inspection.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../testing/basic.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../testing/inspection.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
